---
title: "PowerPrior(git)"
author: "Yuxin"
date: "2025-04-25"
output: html_document
---

```{r}
# Load required libraries
library(rjags)
library(coda)
library(dplyr)
library(ggplot2)
```

```{r}
# Define data
# Follows Binomial distribution
pediatric_data <- list(
  y_placebo = 1,   # Number of responses in pediatric placebo group
  n_placebo = 6,   # Total in pediatric placebo group
  y_drug = 15,     # Number of responses in pediatric drug group 
  n_drug = 30      # Total in pediatric drug group
)

adult_data <- list(
  y_placebo = 45,  # Number of responses in adult placebo group
  n_placebo = 494, # Total in adult placebo group
  y_drug = 375,    # Number of responses in adult drug group
  n_drug = 509     # Total in adult drug group
)
```

Method 1: Implement Power Prior using RJAGS

The pediatric data are modeled with a binomial likelihood, and the adult data, weighted through the power prior, form a Beta prior to jointly infer the posterior of p.

```{r}
#------ Method 1: Implement Power Prior using RJAGS ------
power_prior_rjags <- function(ped_data, adult_data, alpha, n_iter = 10000) {
  # Define the JAGS model
  model_string <- "
  model {
    # Likelihood for pediatric data
    # Observed pediatric data modeled using binomial distribution
    y_ped_placebo ~ dbin(p_placebo, n_ped_placebo)
    y_ped_drug ~ dbin(p_drug, n_ped_drug)
    
    # Likelihood for adult data (weighted via power prior)
    # Equivalent to down-weighting adult data to an effective sample size
    # Transform adult data into Beta prior parameters (α as borrowing strength)
    a_placebo <- 1 + alpha * y_adult_placebo
    b_placebo <- 1 + alpha * (n_adult_placebo - y_adult_placebo)
    
    a_drug <- 1 + alpha * y_adult_drug
    b_drug <- 1 + alpha * (n_adult_drug - y_adult_drug)
    
    # Prior distribution (Beta distribution)
    # Use Beta priors to directly reflect the result of Power Prior construction
    p_placebo ~ dbeta(a_placebo, b_placebo)
    p_drug ~ dbeta(a_drug, b_drug)
    
    # Compute odds ratio
    odds_ratio <- (p_drug / (1 - p_drug)) / (p_placebo / (1 - p_placebo))
    log_odds_ratio <- log(odds_ratio)
  }
  "
  
  # Prepare JAGS data list
  jags_data <- list(
    y_ped_placebo = ped_data$y_placebo,
    n_ped_placebo = ped_data$n_placebo,
    y_ped_drug = ped_data$y_drug,
    n_ped_drug = ped_data$n_drug,
    y_adult_placebo = adult_data$y_placebo,
    n_adult_placebo = adult_data$n_placebo,
    y_adult_drug = adult_data$y_drug,
    n_adult_drug = adult_data$n_drug,
    alpha = alpha
  )
  
  # Initialize the JAGS model
  jags_model <- jags.model(textConnection(model_string), 
                           data = jags_data, 
                           n.chains = 3, 
                           quiet = TRUE)
  
  # Burn-in
  update(jags_model, 5000, progress.bar = "none")
  
  # Draw posterior samples
  samples <- coda.samples(jags_model, 
                         variable.names = c("p_placebo", "p_drug", "odds_ratio", "log_odds_ratio"), 
                         n.iter = n_iter, 
                         progress.bar = "none")
  
  # Convert to matrix for processing
  samples_matrix <- as.matrix(samples)
  
  # Compute summary statistics
  or_samples <- samples_matrix[, "odds_ratio"]
  median_or <- median(or_samples)
  ci_95 <- quantile(or_samples, c(0.025, 0.975))
  prob_gt_1 <- mean(or_samples > 1)  # Probability that OR > 1
  
  return(list(
    median_or = median_or,
    ci_95 = ci_95,
    prob_gt_1 = prob_gt_1,
    samples = or_samples
  ))
}

# Call this function once to output the OR estimate at a specific alpha
```

Method 2: Direct Beta-Binomial Implementation

```{r}
#------ Method 2: Direct Beta-Binomial Approach ------
power_prior_beta <- function(ped_data, adult_data, alpha, n_samples = 10000) {
  # Base prior parameters (same as in RJAGS method)
  a0 <- 1
  b0 <- 1
  
  # Construct the prior incorporating adult data
  # Adult data is treated as "α-weighted pseudo sample size" and added to the original prior
  a_placebo <- a0 + alpha * adult_data$y_placebo
  b_placebo <- b0 + alpha * (adult_data$n_placebo - adult_data$y_placebo)
  
  a_drug <- a0 + alpha * adult_data$y_drug
  b_drug <- b0 + alpha * (adult_data$n_drug - adult_data$y_drug)
  
  # Add pediatric data to get posterior parameters
  a_placebo_post <- a_placebo + ped_data$y_placebo
  b_placebo_post <- b_placebo + (ped_data$n_placebo - ped_data$y_placebo)
  
  a_drug_post <- a_drug + ped_data$y_drug
  b_drug_post <- b_drug + (ped_data$n_drug - ped_data$y_drug)
  
  # Sample directly from the posterior distribution
  # Simulate posterior distribution of response probabilities
  p_placebo_samples <- rbeta(n_samples, a_placebo_post, b_placebo_post)
  p_drug_samples <- rbeta(n_samples, a_drug_post, b_drug_post)
  
  # Calculate odds ratios
  or_samples <- (p_drug_samples / (1 - p_drug_samples)) / 
                (p_placebo_samples / (1 - p_placebo_samples))
  
  # Compute summary statistics
  median_or <- median(or_samples)
  ci_95 <- quantile(or_samples, c(0.025, 0.975))
  prob_gt_1 <- mean(or_samples > 1)  # Probability that OR > 1
  
  return(list(
    median_or = median_or,
    ci_95 = ci_95,
    prob_gt_1 = prob_gt_1,
    samples = or_samples
  ))
}

```


Tipping point detection and visualization!!

```{r}
#------ Power Prior: Tipping Point Analysis ------
# Analyze, compare, and visualize Power Prior (RJAGS & Beta-Binomial) across a range of α values,
# and identify tipping points where the lower bound of the 95% CrI for OR exceeds 1.

tipping_point_analysis <- function(ped_data, adult_data, method = "both",
                                  alpha_min = 0.001, alpha_max = 0.01, steps = 100) {
  alpha_seq <- seq(alpha_min, alpha_max, length.out = steps)
  results <- data.frame()
  
  for (alpha in alpha_seq) {
    if (method %in% c("both", "RJAGS")) {
      rjags_res <- power_prior_rjags(ped_data, adult_data, alpha)
      results <- rbind(results, data.frame(
        alpha = alpha,
        method = "RJAGS",
        median_or = rjags_res$median_or,
        lower_ci = rjags_res$ci_95[1],
        upper_ci = rjags_res$ci_95[2],
        prob_gt_1 = rjags_res$prob_gt_1
      ))
    }
    
    if (method %in% c("both", "Beta-Binomial")) {
      beta_res <- power_prior_beta(ped_data, adult_data, alpha)
      results <- rbind(results, data.frame(
        alpha = alpha,
        method = "Beta-Binomial",
        median_or = beta_res$median_or,
        lower_ci = beta_res$ci_95[1],
        upper_ci = beta_res$ci_95[2],
        prob_gt_1 = beta_res$prob_gt_1
      ))
    }
  }
  
  # Identify tipping points (first alpha where 95% CrI lower bound > 1)
  if ("RJAGS" %in% unique(results$method)) {
    rjags_data <- subset(results, method == "RJAGS")
    rjags_tp_idx <- which(rjags_data$lower_ci > 1)[1]
    rjags_tipping <- ifelse(is.na(rjags_tp_idx), NA, rjags_data$alpha[rjags_tp_idx])
    cat("RJAGS Tipping Point (OR lower bound > 1):", ifelse(is.na(rjags_tipping), "Not Found", 
                                              paste0(scales::percent(rjags_tipping, accuracy = 0.001))), "\n")
  }
  
  if ("Beta-Binomial" %in% unique(results$method)) {
    beta_data <- subset(results, method == "Beta-Binomial")
    beta_tp_idx <- which(beta_data$lower_ci > 1)[1]
    beta_tipping <- ifelse(is.na(beta_tp_idx), NA, beta_data$alpha[beta_tp_idx])
    cat("Beta-Binomial Tipping Point (OR lower bound > 1):", ifelse(is.na(beta_tipping), "Not Found", 
                                                     paste0(scales::percent(beta_tipping, accuracy = 0.001))), "\n")
  }
  
  # Create visualization
  p <- ggplot(results, aes(x = alpha, color = method, group = method)) +
    geom_line(aes(y = median_or), size = 1) +
    geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = method), alpha = 0.2) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "black") +
    labs(title = "Tipping Point Analysis: Borrowing Weight vs OR",
         subtitle = "Showing 95% Credible Intervals",
         x = "Borrowing Weight (α)",
         y = "Odds Ratio (OR)",
         color = "Method",
         fill = "Method") +
    theme_minimal() +
    scale_x_continuous(labels = scales::percent_format(accuracy = 0.001))
  
  # Annotate tipping points on plot if available
  if (exists("rjags_tipping") && !is.na(rjags_tipping)) {
    p <- p + geom_vline(xintercept = rjags_tipping, linetype = "dotted", 
                       color = "blue", size = 1)
  }
  
  if (exists("beta_tipping") && !is.na(beta_tipping)) {
    p <- p + geom_vline(xintercept = beta_tipping, linetype = "dotted", 
                       color = "red", size = 1)
  }
  
  return(list(
    results = results,
    plot = p,
    rjags_tipping = if (exists("rjags_tipping")) rjags_tipping else NA,
    beta_tipping = if (exists("beta_tipping")) beta_tipping else NA
  ))
}

```


```{r}
# More fine-grained tipping point analysis, focusing on the range between 0.1% and 0.8%
tp_analysis <- tipping_point_analysis(pediatric_data, adult_data, 
                                      alpha_min = 0.001, 
                                      alpha_max = 0.008, 
                                      steps = 70)
print(tp_analysis$plot)
```

```{r}
# Output the exact tipping point values (displayed as percentages)
cat("\n--- Tipping Point Values (Information Borrowing Weight) ---\n")
cat("RJAGS Method:", ifelse(is.na(tp_analysis$rjags_tipping), "Not found", 
                      paste0(scales::percent(tp_analysis$rjags_tipping, accuracy = 0.001))), "\n")
cat("Beta-Binomial Method:", ifelse(is.na(tp_analysis$beta_tipping), "Not found", 
                             paste0(scales::percent(tp_analysis$beta_tipping, accuracy = 0.001))), "\n")

```

Calculate Effective Sample Size (ESS)

```{r}
# Method 1: ESS for Beta-Binomial method
evaluate_ess_beta <- function(ped_data, adult_data, alpha) {
  # For Beta-Binomial model, ESS = alpha * historical sample size
  ess_treat <- alpha * adult_data$n_drug
  ess_placebo <- alpha * adult_data$n_placebo
  ess_total <- ess_treat + ess_placebo
  
  ess_ratio_treat <- ess_treat / ped_data$n_drug
  ess_ratio_placebo <- ess_placebo / ped_data$n_placebo
  ess_ratio_total <- ess_total / (ped_data$n_drug + ped_data$n_placebo)
  
  return(list(
    ess_treat = ess_treat,
    ess_placebo = ess_placebo,
    ess_total = ess_total,
    ess_ratio_treat = ess_ratio_treat,
    ess_ratio_placebo = ess_ratio_placebo,
    ess_ratio_total = ess_ratio_total
  ))
}
```

```{r}
# Method 2: ESS for RJAGS method (same calculation logic, because adult info is down-weighted by alpha)
evaluate_ess_rjags <- function(ped_data, adult_data, alpha) {
  # In RJAGS with power prior, effective contribution is also alpha * sample size
  ess_treat <- alpha * adult_data$n_drug
  ess_placebo <- alpha * adult_data$n_placebo
  ess_total <- ess_treat + ess_placebo
  
  ess_ratio_treat <- ess_treat / ped_data$n_drug
  ess_ratio_placebo <- ess_placebo / ped_data$n_placebo
  ess_ratio_total <- ess_total / (ped_data$n_drug + ped_data$n_placebo)
  
  return(list(
    ess_treat = ess_treat,
    ess_placebo = ess_placebo,
    ess_total = ess_total,
    ess_ratio_treat = ess_ratio_treat,
    ess_ratio_placebo = ess_ratio_placebo,
    ess_ratio_total = ess_ratio_total
  ))
}
```

```{r}
#------ Summarize ESS at Tipping Point ------

# Assuming tipping point results already available from previous analysis
tp_rjags_alpha <- tp_analysis$rjags_tipping
tp_beta_alpha <- tp_analysis$beta_tipping

# Calculate ESS at RJAGS tipping point
if (!is.na(tp_rjags_alpha)) {
  ess_rjags <- evaluate_ess_rjags(pediatric_data, adult_data, tp_rjags_alpha)
  cat("\n--- ESS at RJAGS Tipping Point (", scales::percent(tp_rjags_alpha, accuracy = 0.001), ") ---\n")
  cat("Treatment ESS:", round(ess_rjags$ess_treat, 2), "\n")
  cat("Placebo ESS:", round(ess_rjags$ess_placebo, 2), "\n")
  cat("Total ESS:", round(ess_rjags$ess_total, 2), "\n")
  cat("ESS to pediatric sample size ratio:", round(ess_rjags$ess_ratio_total, 3), "\n")
}

# Calculate ESS at Beta-Binomial tipping point
if (!is.na(tp_beta_alpha)) {
  ess_beta <- evaluate_ess_beta(pediatric_data, adult_data, tp_beta_alpha)
  cat("\n--- ESS at Beta-Binomial Tipping Point (", scales::percent(tp_beta_alpha, accuracy = 0.001), ") ---\n")
  cat("Treatment ESS:", round(ess_beta$ess_treat, 2), "\n")
  cat("Placebo ESS:", round(ess_beta$ess_placebo, 2), "\n")
  cat("Total ESS:", round(ess_beta$ess_total, 2), "\n")
  cat("ESS to pediatric sample size ratio:", round(ess_beta$ess_ratio_total, 3), "\n")
}
```
plot how the Effective Sample Size (ESS) changes with α for the RJAGS and Beta-Binomial.

```{r}
# Create ESS calculation function
calculate_ess <- function(ped_data, adult_data, alpha) {
  ess_treat <- alpha * adult_data$n_drug
  ess_placebo <- alpha * adult_data$n_placebo
  ess_total <- ess_treat + ess_placebo
  ess_ratio_total <- ess_total / (ped_data$n_drug + ped_data$n_placebo)
  
  return(list(
    ess_treat = ess_treat,
    ess_placebo = ess_placebo,
    ess_total = ess_total,
    ess_ratio_total = ess_ratio_total
  ))
}

# Add ESS calculation to the tipping point results
tp_results_with_ess <- tp_analysis$results %>%
  mutate(
    ess_treat = alpha * adult_data$n_drug,
    ess_placebo = alpha * adult_data$n_placebo,
    ess_total = ess_treat + ess_placebo,
    ess_ratio_total = ess_total / (pediatric_data$n_drug + pediatric_data$n_placebo)
  )

# Separate RJAGS and Beta-Binomial results
rjags_ess <- tp_results_with_ess %>% filter(method == "RJAGS")
beta_ess <- tp_results_with_ess %>% filter(method == "Beta-Binomial")

# Plot for RJAGS
ess_plot_rjags <- ggplot(rjags_ess, aes(x = alpha)) +
  geom_area(aes(y = ess_total), fill = "lightblue", alpha = 0.4) +
  geom_line(aes(y = ess_treat), color = "red", size = 1, linetype = "solid") +
  geom_line(aes(y = ess_placebo), color = "darkgreen", size = 1, linetype = "dashed") +
  {if (!is.na(tp_analysis$rjags_tipping))
    geom_vline(xintercept = tp_analysis$rjags_tipping, color = "blue", linetype = "dotted", size = 1)} +
  labs(title = "Effective Sample Size Components (RJAGS Method)",
       x = "Borrowing Weight (α)",
       y = "Effective Sample Size",
       fill = "",
       color = "") +
  theme_minimal() +
  scale_x_continuous(labels = scales::percent_format(accuracy = 0.1)) +
  theme(legend.position = "bottom")

# Plot for Beta-Binomial
ess_plot_beta <- ggplot(beta_ess, aes(x = alpha)) +
  geom_area(aes(y = ess_total), fill = "lightpink", alpha = 0.4) +
  geom_line(aes(y = ess_treat), color = "red", size = 1, linetype = "solid") +
  geom_line(aes(y = ess_placebo), color = "darkgreen", size = 1, linetype = "dashed") +
  {if (!is.na(tp_analysis$beta_tipping))
    geom_vline(xintercept = tp_analysis$beta_tipping, color = "red", linetype = "dotted", size = 1)} +
  labs(title = "Effective Sample Size Components (Beta-Binomial Method)",
       x = "Borrowing Weight (α)",
       y = "Effective Sample Size",
       fill = "",
       color = "") +
  theme_minimal() +
  scale_x_continuous(labels = scales::percent_format(accuracy = 0.1)) +
  theme(legend.position = "bottom")

# Print the two plots separately
print(ess_plot_rjags)
print(ess_plot_beta)
```
