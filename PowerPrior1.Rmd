---
title: "PowerPrior"
author: "Yuxin"
date: "2025-04-23"
output: html_document
---

```{r}
# 加载必要的库
library(rjags)
library(coda)
library(ggplot2)
```

```{r}
# 定义数据
# 符合二项分布（Binomial）
pediatric_data <- list(
  y_placebo = 1,   # 安慰剂组反应数
  n_placebo = 6,   # 安慰剂组总数
  y_drug = 15,     # 药物组反应数 
  n_drug = 30      # 药物组总数
)

adult_data <- list(
  y_placebo = 45,  # 成人安慰剂组反应数
  n_placebo = 494, # 成人安慰剂组总数
  y_drug = 375,    # 成人药物组反应数
  n_drug = 509     # 成人药物组总数
)
```

```{r}
#------ 方法1: 使用RJAGS实现Power Prior ------
power_prior_rjags <- function(ped_data, adult_data, alpha, n_iter = 10000) {
  # JAGS模型定义
  model_string <- "
  model {
    # 儿童数据的似然函数
    # 观测数据（儿童）采用二项分布建模
    y_ped_placebo ~ dbin(p_placebo, n_ped_placebo)
    y_ped_drug ~ dbin(p_drug, n_ped_drug)
    
    # 成人数据的似然函数（通过power prior权重）
    # 相当于将成人数据缩放为等效样本量
    # 成人数据转化为 Beta 先验的参数（α 借用强度）
    a_placebo <- 1 + alpha * y_adult_placebo
    b_placebo <- 1 + alpha * (n_adult_placebo - y_adult_placebo)
    
    a_drug <- 1 + alpha * y_adult_drug
    b_drug <- 1 + alpha * (n_adult_drug - y_adult_drug)
    
    # 先验分布（Beta分布）
    # 使用 Beta 先验 直接反映 Power Prior 构造的结果
    p_placebo ~ dbeta(a_placebo, b_placebo)
    p_drug ~ dbeta(a_drug, b_drug)
    
    # 计算比值比
    odds_ratio <- (p_drug/(1-p_drug))/(p_placebo/(1-p_placebo))
    log_odds_ratio <- log(odds_ratio)
  }
  "
  
  # 准备JAGS数据
  jags_data <- list(
    y_ped_placebo = ped_data$y_placebo,
    n_ped_placebo = ped_data$n_placebo,
    y_ped_drug = ped_data$y_drug,
    n_ped_drug = ped_data$n_drug,
    y_adult_placebo = adult_data$y_placebo,
    n_adult_placebo = adult_data$n_placebo,
    y_adult_drug = adult_data$y_drug,
    n_adult_drug = adult_data$n_drug,
    alpha = alpha
  )
  
  # 初始化JAGS模型
  jags_model <- jags.model(textConnection(model_string), 
                           data = jags_data, 
                           n.chains = 3, 
                           quiet = TRUE)
  
  # 预热
  update(jags_model, 5000, progress.bar = "none")
  
  # 从后验抽样
  samples <- coda.samples(jags_model, 
                         variable.names = c("p_placebo", "p_drug", "odds_ratio", "log_odds_ratio"), 
                         n.iter = n_iter, 
                         progress.bar = "none")
  
  # 转为矩阵处理
  samples_matrix <- as.matrix(samples)
  
  # 计算统计量
  or_samples <- samples_matrix[, "odds_ratio"]
  median_or <- median(or_samples)
  ci_95 <- quantile(or_samples, c(0.025, 0.975))
  prob_gt_1 <- mean(or_samples > 1)  # 添加OR>1的概率
  
  return(list(
    median_or = median_or,
    ci_95 = ci_95,
    prob_gt_1 = prob_gt_1,
    samples = or_samples
  ))
}
#只做一次，输出某个 α 下 OR 的估计
```

```{r}

#------ 方法2: 使用Beta-二项式直接法 ------
power_prior_beta <- function(ped_data, adult_data, alpha, n_samples = 10000) {
  # 基础先验参数 (与RJAGS方法一致)
  a0 <- 1
  b0 <- 1
  
  # 计算包含成人数据的先验,成人数据变成了 “α 倍的虚拟样本量” 并加到原始先验上
  a_placebo <- a0 + alpha * adult_data$y_placebo
  b_placebo <- b0 + alpha * (adult_data$n_placebo - adult_data$y_placebo)
  
  a_drug <- a0 + alpha * adult_data$y_drug
  b_drug <- b0 + alpha * (adult_data$n_drug - adult_data$y_drug)
  
  # 添加儿童数据得到后验
  a_placebo_post <- a_placebo + ped_data$y_placebo
  b_placebo_post <- b_placebo + (ped_data$n_placebo - ped_data$y_placebo)
  
  a_drug_post <- a_drug + ped_data$y_drug
  b_drug_post <- b_drug + (ped_data$n_drug - ped_data$y_drug)
  
  # 从后验分布直接抽样,模拟 posterior distribution；得到一组成功概率的后验样本
  p_placebo_samples <- rbeta(n_samples, a_placebo_post, b_placebo_post)
  p_drug_samples <- rbeta(n_samples, a_drug_post, b_drug_post)
  
  # 计算比值比
  or_samples <- (p_drug_samples/(1-p_drug_samples))/(p_placebo_samples/(1-p_placebo_samples))
  
  # 计算统计量
  median_or <- median(or_samples)
  ci_95 <- quantile(or_samples, c(0.025, 0.975))
  prob_gt_1 <- mean(or_samples > 1)  # 添加OR>1的概率
  
  return(list(
    median_or = median_or,
    ci_95 = ci_95,
    prob_gt_1 = prob_gt_1,
    samples = or_samples
  ))
}
```

#下面两步只是简单比较这两个方法，可视化差距，tipping point可以直接跳到下下面

```{r}

#------ 比较两种方法，使用更细的alpha范围 ------
#alpha_range：你想考察的 α 范围（默认是 [0, 0.01]）,steps：你想测试多少个 α 点（默认是 50）
compare_methods_fine <- function(ped_data, adult_data, 
                                alpha_range = c(0, 0.01), 
                                steps = 50) {
  # 创建更细的alpha序列，集中在0.004左右
  alpha_seq <- seq(alpha_range[1], alpha_range[2], length.out = steps)
  
  results <- data.frame()
  
  for (alpha in alpha_seq) {
    # RJAGS方法
    rjags_res <- power_prior_rjags(ped_data, adult_data, alpha)
    
    # Beta-二项式方法
    beta_res <- power_prior_beta(ped_data, adult_data, alpha)
    
    # 整合结果
    results <- rbind(results, data.frame(
      alpha = alpha,
      method = "RJAGS",
      median_or = rjags_res$median_or,
      lower_ci = rjags_res$ci_95[1],
      upper_ci = rjags_res$ci_95[2],
      prob_gt_1 = rjags_res$prob_gt_1
    ))
    
    results <- rbind(results, data.frame(
      alpha = alpha,
      method = "Beta-Binomial",
      median_or = beta_res$median_or,
      lower_ci = beta_res$ci_95[1],
      upper_ci = beta_res$ci_95[2],
      prob_gt_1 = beta_res$prob_gt_1
    ))
  }
  
  return(results)
}

```

```{r}

#------ 增强的图形化比较结果 ------
#可视化 Power Prior 两种实现方法（RJAGS 与 Beta-Binomial）对比效果
plot_comparison_enhanced <- function(comparison_results) {
  # 绘制比值比图
  p1 <- ggplot(comparison_results, aes(x = alpha, y = median_or, color = method, group = method)) +
    geom_line(size = 1) +
    geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = method), alpha = 0.2) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "black") +
    labs(title = "比值比(OR)与信息借用权重的关系",
         x = "信息借用权重 (α)",
         y = "比值比 (OR)",
         color = "方法",
         fill = "方法") +
    theme_minimal() +
    scale_x_continuous(labels = scales::percent_format(accuracy = 0.1))
  
  # 绘制OR>1概率图
  p2 <- ggplot(comparison_results, aes(x = alpha, y = prob_gt_1, color = method, group = method)) +
    geom_line(size = 1) +
    geom_hline(yintercept = 0.95, linetype = "dashed", color = "red") +
    labs(title = "OR>1概率与信息借用权重的关系",
         x = "信息借用权重 (α)",
         y = "P(OR > 1)",
         color = "方法") +
    theme_minimal() +
    scale_x_continuous(labels = scales::percent_format(accuracy = 0.1)) +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1))
  
  # 找出tipping points，即OR>1概率达到95%的最小α值
  find_tipping_point <- function(data) {
    # 修改后的定义：找出 95% CrI 下限 > 1 的最小 alpha
    tp_idx <- which(data$lower_ci > 1)[1]
    if(!is.na(tp_idx)) {
      return(data$alpha[tp_idx])
    } else {
      return(NA)
    }
  }
  
  #用它分别作用在 RJAGS 和 Beta 方法结果上
  rjags_data <- subset(comparison_results, method == "RJAGS")
  beta_data <- subset(comparison_results, method == "Beta-Binomial")
  
  rjags_tipping <- find_tipping_point(rjags_data)
  beta_tipping <- find_tipping_point(beta_data)
  
  # 如果找到tipping points，在图上显示
  if(!is.na(rjags_tipping)) {
    p2 <- p2 + geom_vline(xintercept = rjags_tipping, linetype = "dotted", 
                        color = "blue", size = 1)
    p2 <- p2 + annotate("text", x = rjags_tipping * 1.1, y = 0.9, 
                      label = paste("RJAGS TP:", scales::percent(rjags_tipping, accuracy = 0.001)), 
                      color = "blue", hjust = 0)
  }
  
  if(!is.na(beta_tipping)) {
    p2 <- p2 + geom_vline(xintercept = beta_tipping, linetype = "dotted", 
                        color = "red", size = 1)
    p2 <- p2 + annotate("text", x = beta_tipping * 1.1, y = 0.85, 
                      label = paste("Beta-Binomial TP:", scales::percent(beta_tipping, accuracy = 0.001)), 
                      color = "red", hjust = 0)
  }
  
  # 组合图表
  library(gridExtra)
  grid.arrange(p1, p2, nrow = 2)
  
  # 返回tipping points
  return(list(
    rjags_tipping = rjags_tipping,
    beta_tipping = beta_tipping,
    plots = list(p1 = p1, p2 = p2)
  ))
}

```

在特定的 α 范围内，对比 RJAGS 与 Beta-Binomial 两种 Power Prior 方法在 OR 推断上的结果，并找出每种方法的 tipping point（使 OR 的 95% 下限 > 1 的最小 α），同时可视化结果。

```{r}
# Power Prior 下两种方法（RJAGS 和 Beta-Binomial）在不同 α 值下的分析、比较、找 tipping point 和可视化
# 深入分析特定alpha范围
tipping_point_analysis <- function(ped_data, adult_data, method = "both",
                                  alpha_min = 0.001, alpha_max = 0.01, steps = 100) {
  alpha_seq <- seq(alpha_min, alpha_max, length.out = steps)
  results <- data.frame()
  
  for (alpha in alpha_seq) {
    if (method %in% c("both", "RJAGS")) {
      rjags_res <- power_prior_rjags(ped_data, adult_data, alpha)
      results <- rbind(results, data.frame(
        alpha = alpha,
        method = "RJAGS",
        median_or = rjags_res$median_or,
        lower_ci = rjags_res$ci_95[1],
        upper_ci = rjags_res$ci_95[2],
        prob_gt_1 = rjags_res$prob_gt_1
      ))
    }
    
    if (method %in% c("both", "Beta-Binomial")) {
      beta_res <- power_prior_beta(ped_data, adult_data, alpha)
      results <- rbind(results, data.frame(
        alpha = alpha,
        method = "Beta-Binomial",
        median_or = beta_res$median_or,
        lower_ci = beta_res$ci_95[1],
        upper_ci = beta_res$ci_95[2],
        prob_gt_1 = beta_res$prob_gt_1
      ))
    }
  }
  
  # 找出tipping points
  if ("RJAGS" %in% unique(results$method)) {
    rjags_data <- subset(results, method == "RJAGS")
    rjags_tp_idx <- which(rjags_data$lower_ci > 1)[1]
    rjags_tipping <- ifelse(is.na(rjags_tp_idx), NA, rjags_data$alpha[rjags_tp_idx])
    cat("RJAGS Tipping Point (OR下限>1):", ifelse(is.na(rjags_tipping), "未找到", 
                                              paste0(scales::percent(rjags_tipping, accuracy = 0.001))), "\n")
  }
  
  if ("Beta-Binomial" %in% unique(results$method)) {
    beta_data <- subset(results, method == "Beta-Binomial")
    beta_tp_idx <- which(beta_data$lower_ci > 1)[1]
    beta_tipping <- ifelse(is.na(beta_tp_idx), NA, beta_data$alpha[beta_tp_idx])
    cat("Beta-Binomial Tipping Point (OR下限>1):", ifelse(is.na(beta_tipping), "未找到", 
                                                     paste0(scales::percent(beta_tipping, accuracy = 0.001))), "\n")
  }
  
  # 制作图表
  p <- ggplot(results, aes(x = alpha, color = method, group = method)) +
    geom_line(aes(y = median_or), size = 1) +
    geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = method), alpha = 0.2) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "black") +
    labs(title = "Tipping Point分析：信息借用与OR关系",
         subtitle = "显示95%可信区间",
         x = "信息借用权重 (α)",
         y = "比值比 (OR)",
         color = "方法",
         fill = "方法") +
    theme_minimal() +
    scale_x_continuous(labels = scales::percent_format(accuracy = 0.001))
  
  # 在图上标记tipping points
  if (exists("rjags_tipping") && !is.na(rjags_tipping)) {
    p <- p + geom_vline(xintercept = rjags_tipping, linetype = "dotted", 
                       color = "blue", size = 1)
  }
  
  if (exists("beta_tipping") && !is.na(beta_tipping)) {
    p <- p + geom_vline(xintercept = beta_tipping, linetype = "dotted", 
                       color = "red", size = 1)
  }
  
  return(list(
    results = results,
    plot = p,
    rjags_tipping = if(exists("rjags_tipping")) rjags_tipping else NA,
    beta_tipping = if(exists("beta_tipping")) beta_tipping else NA
  ))
}
```

```{r}

# 执行精细分析，集中在0-1%之间的α值
results_fine <- compare_methods_fine(pediatric_data, adult_data, 
                                    alpha_range = c(0, 0.01), 
                                    steps = 50)
```

```{r}
# 可视化结果
#原因不一样是因为alpha 的搜索范围和步长不同，plot_comparison_enhanced() 依赖的是compare_methods_fine
plot_results <- plot_comparison_enhanced(results_fine)
```

两种方法下的 OR 估计结果在整个 α 范围内都 非常接近，拟合趋势高度一致；

OR 都远高于 1，说明无论多少借用信息，治疗在儿童中似乎都显著优于对照；

当信息借用比例 α 达到约 0.612% 时，两种方法的后验 95% CrI 下限 > 1， → 被标记为各自方法的 Tipping Point；

```{r}
# 更精细的tipping point分析，集中在0.1%-0.8%之间
tp_analysis <- tipping_point_analysis(pediatric_data, adult_data, 
                                     alpha_min = 0.001, 
                                     alpha_max = 0.008, 
                                     steps = 70)
print(tp_analysis$plot)
```

```{r}
# 输出精确的tipping point值（以百分比显示）
cat("\n--- Tipping Point值（信息借用权重） ---\n")
cat("RJAGS方法:", ifelse(is.na(tp_analysis$rjags_tipping), "未找到", 
                     paste0(scales::percent(tp_analysis$rjags_tipping, accuracy = 0.001))), "\n")
cat("Beta-Binomial方法:", ifelse(is.na(tp_analysis$beta_tipping), "未找到", 
                            paste0(scales::percent(tp_analysis$beta_tipping, accuracy = 0.001))), "\n")
```
