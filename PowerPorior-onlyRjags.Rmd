---
title: "Power Prior- OnlyRjags"
author: "Li Zhang & Yuxin Gao"
date: "2025-05-17"
output: html_document
---

```{r}
# Load required libraries
library(rjags)
library(coda)
library(dplyr)
library(ggplot2)
```

```{r}
# Define data
# Follows Binomial distribution
pediatric_data <- list(
  y_placebo = 1,   # Number of responses in pediatric placebo group
  n_placebo = 6,   # Total in pediatric placebo group
  y_drug = 15,     # Number of responses in pediatric drug group 
  n_drug = 30      # Total in pediatric drug group
)

adult_data <- list(
  y_placebo = 45,  # Number of responses in adult placebo group
  n_placebo = 494, # Total in adult placebo group
  y_drug = 375,    # Number of responses in adult drug group
  n_drug = 509     # Total in adult drug group
)
```

## Method 1: Implement Power Prior using RJAGS

The pediatric data are modeled with a binomial likelihood, and the adult data, weighted through the power prior, form a Beta prior to jointly infer the posterior of p.

### Model

```{r}
#------ Method 1: Implement Power Prior using RJAGS ------
power_prior_rjags <- function(ped_data, adult_data, alpha, n_iter = 10000) {
  # Define the JAGS model
  model_string <- "
  model {
    # Likelihood for pediatric data
    # Observed pediatric data modeled using binomial distribution
    y_ped_placebo ~ dbin(p_placebo, n_ped_placebo)
    y_ped_drug ~ dbin(p_drug, n_ped_drug)
    
    # Likelihood for adult data (weighted via power prior)
    # Equivalent to down-weighting adult data to an effective sample size
    # Transform adult data into Beta prior parameters (α as borrowing strength)
    a_placebo <- 1 + alpha * y_adult_placebo
    b_placebo <- 1 + alpha * (n_adult_placebo - y_adult_placebo)
    
    a_drug <- 1 + alpha * y_adult_drug
    b_drug <- 1 + alpha * (n_adult_drug - y_adult_drug)
    
    # Prior distribution (Beta distribution)
    # Use Beta priors to directly reflect the result of Power Prior construction
    p_placebo ~ dbeta(a_placebo, b_placebo)
    p_drug ~ dbeta(a_drug, b_drug)
    
    # Compute response rate 
    # odds_ratio <- (p_drug / (1 - p_drug)) / (p_placebo / (1 - p_placebo))
    # log_odds_ratio <- log(odds_ratio)
    rr_diff <- p_drug - p_placebo
  }
  "
  
  # Prepare JAGS data list
  jags_data <- list(
    y_ped_placebo = ped_data$y_placebo,
    n_ped_placebo = ped_data$n_placebo,
    y_ped_drug = ped_data$y_drug,
    n_ped_drug = ped_data$n_drug,
    y_adult_placebo = adult_data$y_placebo,
    n_adult_placebo = adult_data$n_placebo,
    y_adult_drug = adult_data$y_drug,
    n_adult_drug = adult_data$n_drug,
    alpha = alpha
  )
  
  # Initialize the JAGS model
  jags_model <- jags.model(textConnection(model_string), 
                           data = jags_data, 
                           n.chains = 3, 
                           quiet = TRUE)
  
  # Burn-in
  update(jags_model, 5000, progress.bar = "none")
  
  # Draw posterior samples
  samples <- coda.samples(jags_model, 
                         variable.names = c("p_placebo", "p_drug", "rr_diff"), 
                         n.iter = n_iter, 
                         progress.bar = "none")
  
  # Convert to matrix for processing
  samples_matrix <- as.matrix(samples)
  
  rr_diff <- samples_matrix[, "rr_diff"]
  p_placebo <- samples_matrix[, "p_placebo"]  
  p_drug <- samples_matrix[, "p_drug"] 
  median_rr_diff <- median(rr_diff)
  ci_95 <- quantile(rr_diff, c(0.025, 0.975))
  prob_gt_0 <- mean(rr_diff > 0)  # Probability that log(OR) > 0

  return(list(
    median_rr_diff = median_rr_diff,
    ci_95 = ci_95,
    prob_gt_0 = prob_gt_0,
    samples = rr_diff,
    samples_placebo = p_placebo,  
    samples_drug = p_drug         
  ))
}

```


### Tipping Point 

```{r}
# Run the RJAGS model analysis and collect results for the differences in response rates
run_rjags_rr_diff_analyses <- function(ped_data, adult_data, 
                                     alpha_min = 0.001, alpha_max = 0.5, steps = 100) {
  alpha_seq <- seq(alpha_min, alpha_max, length.out = steps)
  results <- data.frame()
  
  for (alpha in alpha_seq) {
    rjags_res <- power_prior_rjags(ped_data, adult_data, alpha)
    
    results <- rbind(results, data.frame(
      alpha = alpha,
      median_rr_diff = rjags_res$median_rr_diff,
      lower_ci = rjags_res$ci_95[1],
      upper_ci = rjags_res$ci_95[2],
      prob_gt_0 = rjags_res$prob_gt_0
    ))
  }
  
  return(results)
}

# Find the tipping point (the first alpha value that makes the lower bound of the response rate difference > 0)
find_rjags_rr_diff_tipping_point <- function(results) {
  tp_idx <- which(results$lower_ci > 0)[1]
  tipping_point <- ifelse(is.na(tp_idx), NA, results$alpha[tp_idx])
  
  if (!is.na(tipping_point)) {
    cat("RJAGS Tipping Point (RR Diff lower bound > 0):", 
        scales::percent(tipping_point, accuracy = 0.001), "\n")
  } else {
    cat("RJAGS Tipping Point: Not Found in the specified alpha range\n")
  }
  
  return(tipping_point)
}
```


### ESS

```{r}
# Modified grouped ESS calculation function based on posterior variance (RJAGS method)
calculate_ess_from_variance_rjags <- function(ped_data, adult_data, alpha_seq, n_samples = 10000) {
  ess_results <- data.frame(alpha = alpha_seq)
  
  # Calculate the posterior variance (V1) without borrowing - separately for the drug and placebo groups
  # Run the RJAGS model with alpha=0
  no_borrow_res <- power_prior_rjags(ped_data, adult_data, 0)
  
  V1_placebo <- var(no_borrow_res$samples_placebo)
  V1_drug <- var(no_borrow_res$samples_drug)
  V1_diff <- var(no_borrow_res$samples)  
  
  ess_values <- numeric(length(alpha_seq))
  borrowed_values <- numeric(length(alpha_seq))
  variance_ratio_values <- numeric(length(alpha_seq))
  
  placebo_ess_values <- numeric(length(alpha_seq))
  drug_ess_values <- numeric(length(alpha_seq))
  placebo_borrowed_values <- numeric(length(alpha_seq))
  drug_borrowed_values <- numeric(length(alpha_seq))
  placebo_variance_ratio <- numeric(length(alpha_seq))
  drug_variance_ratio <- numeric(length(alpha_seq))
  
  for (i in 1:length(alpha_seq)) {
    alpha <- alpha_seq[i]
    
    # Running the RJAGS model
    borrow_res <- power_prior_rjags(ped_data, adult_data, alpha)
    
    V2_placebo <- var(borrow_res$samples_placebo)
    V2_drug <- var(borrow_res$samples_drug)
    V2_diff <- var(borrow_res$samples) 
    
    variance_ratio_placebo <- V1_placebo / V2_placebo
    variance_ratio_drug <- V1_drug / V2_drug
    variance_ratio_diff <- V1_diff / V2_diff
    
    # Calculate ESS - separately for drug and placebo groups
    n_placebo <- ped_data$n_placebo
    n_drug <- ped_data$n_drug
    n_total <- n_placebo + n_drug
    
    # 修改部分：使用MixturePrior风格计算ESS（只包括借用的样本量）
    placebo_ess <- n_placebo * (variance_ratio_placebo - 1)
    drug_ess <- n_drug * (variance_ratio_drug - 1)
    total_ess <- n_total * (variance_ratio_diff - 1)
    
    # 修改部分：借用的样本量现在直接等于ESS（因为ESS已经表示额外借用的样本量）
    placebo_borrowed <- placebo_ess
    drug_borrowed <- drug_ess
    total_borrowed <- total_ess
    
    ess_values[i] <- total_ess
    borrowed_values[i] <- total_borrowed
    variance_ratio_values[i] <- variance_ratio_diff
    
    placebo_ess_values[i] <- placebo_ess
    drug_ess_values[i] <- drug_ess
    placebo_borrowed_values[i] <- placebo_borrowed
    drug_borrowed_values[i] <- drug_borrowed
    placebo_variance_ratio[i] <- variance_ratio_placebo
    drug_variance_ratio[i] <- variance_ratio_drug
  }
  
  ess_results$ess_total <- ess_values
  ess_results$borrowed <- borrowed_values
  ess_results$variance_ratio <- variance_ratio_values
  ess_results$variance_noborrow <- V1_diff
  ess_results$variance_borrow <- numeric(length(alpha_seq))  
  
  ess_results$placebo_ess <- placebo_ess_values
  ess_results$placebo_borrowed <- placebo_borrowed_values
  ess_results$placebo_variance_ratio <- placebo_variance_ratio
  ess_results$placebo_variance_noborrow <- V1_placebo
  
  ess_results$drug_ess <- drug_ess_values
  ess_results$drug_borrowed <- drug_borrowed_values
  ess_results$drug_variance_ratio <- drug_variance_ratio
  ess_results$drug_variance_noborrow <- V1_drug
  
  for (i in 1:length(alpha_seq)) {
    alpha <- alpha_seq[i]
    borrow_res <- power_prior_rjags(ped_data, adult_data, alpha)
    ess_results$variance_borrow[i] <- var(borrow_res$samples)
  }
  
  return(ess_results)
}
```

### Visualization


```{r}
# Create a plot of the response rate differences (leave it as is)
plot_rjags_rr_diff <- function(results, tipping_point = NA) {
  alpha_min <- min(results$alpha)
  alpha_max <- max(results$alpha)
  
  p <- ggplot(results, aes(x = alpha)) +
    geom_line(aes(y = median_rr_diff), size = 1, color = "darkblue") +
    geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.2, fill = "steelblue") +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    labs(title = "RJAGS Tipping Point Analysis: Borrowing Weight vs Response Rate Difference",
         subtitle = "Showing 95% Credible Intervals",
         x = "Borrowing Weight (α)",
         y = "Response Rate Difference (Drug - Placebo)") +
    theme_minimal() +
    scale_x_continuous(labels = scales::percent_format(accuracy = 0.1))
  
  if (!is.na(tipping_point)) {
    p <- p + 
      geom_vline(xintercept = tipping_point, linetype = "dotted", color = "purple", size = 1) +
      annotate("text", x = tipping_point + (alpha_max - alpha_min) * 0.05, 
               y = min(results$lower_ci) + (max(results$upper_ci) - min(results$lower_ci)) * 0.9, 
               label = paste0("Tipping Point: ", scales::percent(tipping_point, accuracy = 0.1)),
               color = "purple", hjust = 0)
  }
  
  return(p)
}

# Create a probability plot 
plot_rjags_probability <- function(results, tipping_point = NA) {
  p <- ggplot(results, aes(x = alpha, y = prob_gt_0)) +
    geom_line(size = 1, color = "darkgreen") +
    geom_hline(yintercept = 0.95, linetype = "dashed", color = "red") +
    labs(title = "RJAGS Posterior Probability of Positive Treatment Effect",
         subtitle = "Probability that Response Rate Difference > 0",
         x = "Borrowing Weight (α)",
         y = "P(RR Diff > 0)") +
    theme_minimal() +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 1)) +
    scale_x_continuous(labels = scales::percent_format(accuracy = 0.1))
  
  if (!is.na(tipping_point)) {
    p <- p + 
      geom_vline(xintercept = tipping_point, linetype = "dotted", color = "purple", size = 1)
  }
  
  return(p)
}

# Create an overall ESS graph 
# 修改后的overall ESS图表函数
plot_rjags_ess <- function(ess_results, tipping_point = NA, ped_data) {
  alpha_min <- min(ess_results$alpha)
  alpha_max <- max(ess_results$alpha)
  n_total <- ped_data$n_drug + ped_data$n_placebo
  
  p <- ggplot(ess_results, aes(x = alpha)) +
    geom_line(aes(y = ess_total), size = 1, color = "darkorange") +
    # 移除原始样本量参考线，因为现在ESS表示借用的样本量，不是总ESS
    # geom_hline(yintercept = n_total, linetype = "dashed", color = "blue", size = 0.8) +
    # 改为在y=0处添加参考线
    geom_hline(yintercept = 0, linetype = "dashed", color = "blue", size = 0.8) +
    
    # 修改标题和副标题以反映新的ESS定义
    labs(title = "RJAGS Borrowed Sample Size Analysis based on Variance Ratio",
         subtitle = "ESS = n * (V1/V2 - 1) where V1, V2 are variances without and with borrowing",
         x = "Borrowing Weight (α)",
         y = "Borrowed Sample Size") +  # 修改y轴标签
    theme_minimal() +
    scale_x_continuous(labels = scales::percent_format(accuracy = 0.1))
  
  # 不再需要双Y轴，因为ESS现在直接表示借用的样本量
  # p <- p + scale_y_continuous(
  #  name = "Effective Sample Size",
  #  sec.axis = sec_axis(~(. - n_total), name = "Borrowed Sample Size")
  # )
  
  if (!is.na(tipping_point)) {
    tp_idx <- which(abs(ess_results$alpha - tipping_point) == min(abs(ess_results$alpha - tipping_point)))
    tp_ess <- ess_results$ess_total[tp_idx]
    
    p <- p + 
      geom_vline(xintercept = tipping_point, linetype = "dotted", color = "purple", size = 1) +
      annotate("text", x = tipping_point + (alpha_max - alpha_min) * 0.05, 
               y = max(ess_results$ess_total) * 0.5,
               # 修改标签，现在ESS与借用样本量相同
               label = paste0("Borrowed ESS at TP: ", round(tp_ess, 1)),
               color = "purple", hjust = 0)
  }
  
  return(p)
}


plot_rjags_variance_ratio <- function(ess_results, tipping_point = NA) {
  alpha_min <- min(ess_results$alpha)
  alpha_max <- max(ess_results$alpha)
  
  p <- ggplot(ess_results, aes(x = alpha)) +
    geom_line(aes(y = variance_ratio), size = 1, color = "purple") +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray50") +
    labs(title = "RJAGS Variance Ratio Analysis",
         subtitle = "Ratio of posterior variances: V1/V2",
         x = "Borrowing Weight (α)",
         y = "Variance Ratio (V1/V2)") +
    theme_minimal() +
    scale_x_continuous(labels = scales::percent_format(accuracy = 0.1))
  
  if (!is.na(tipping_point)) {
    tp_idx <- which(abs(ess_results$alpha - tipping_point) == min(abs(ess_results$alpha - tipping_point)))
    tp_var_ratio <- ess_results$variance_ratio[tp_idx]
    
    p <- p + 
      geom_vline(xintercept = tipping_point, linetype = "dotted", color = "purple", size = 1) +
      annotate("text", x = tipping_point + (alpha_max - alpha_min) * 0.05, 
               y = max(ess_results$variance_ratio) * 0.8,
               label = paste0("Var Ratio at TP: ", round(tp_var_ratio, 2)),
               color = "purple", hjust = 0)
  }
  
  return(p)
}

# Creating a Grouped ESS Plot
# 修改后的分组ESS图表函数
plot_rjags_group_ess <- function(ess_results, tipping_point = NA, ped_data) {
  alpha_min <- min(ess_results$alpha)
  alpha_max <- max(ess_results$alpha)
  
  n_placebo <- ped_data$n_placebo
  n_drug <- ped_data$n_drug
  n_total <- n_placebo + n_drug
  
  p <- ggplot(ess_results, aes(x = alpha)) +
    geom_line(aes(y = drug_ess, color = "Drug Group"), size = 1) +
    geom_line(aes(y = placebo_ess, color = "Placebo Group"), size = 1) +
    geom_line(aes(y = ess_total, color = "Total"), size = 1, linetype = "dashed") +
    
    # 移除原始样本量参考线，改为在y=0处添加参考线
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50", size = 0.6) +
    
    # 修改标题以反映新的ESS定义
    labs(title = "RJAGS Group-Specific Borrowed Sample Size Analysis",
         subtitle = "Based on Group-Specific Variance Ratios: ESS = n * (V1/V2 - 1)",
         x = "Borrowing Weight (α)",
         y = "Borrowed Sample Size",  # 修改Y轴标签
         color = "Group") +
    
    scale_color_manual(values = c("Drug Group" = "blue", 
                                  "Placebo Group" = "red", 
                                  "Total" = "purple")) +
    theme_minimal() +
    scale_x_continuous(labels = scales::percent_format(accuracy = 0.1)) +
    theme(legend.position = "bottom")
  
  # 如果有临界点，添加相关注释
  if (!is.na(tipping_point)) {
    tp_idx <- which(abs(ess_results$alpha - tipping_point) == min(abs(ess_results$alpha - tipping_point)))
    tp_drug_ess <- ess_results$drug_ess[tp_idx]
    tp_placebo_ess <- ess_results$placebo_ess[tp_idx]
    tp_total_ess <- ess_results$ess_total[tp_idx]
    
    # 不再需要计算借用样本量，因为ESS现在直接表示借用的样本量
    # tp_drug_borrowed <- tp_drug_ess - n_drug
    # tp_placebo_borrowed <- tp_placebo_ess - n_placebo
    # tp_total_borrowed <- tp_total_ess - n_total
    
    # 添加临界点的垂直线
    p <- p + 
      geom_vline(xintercept = tipping_point, linetype = "dotted", color = "black", size = 0.8) +
      annotate("text", x = tipping_point + (alpha_max - alpha_min) * 0.05, 
               y = max(c(ess_results$drug_ess, ess_results$placebo_ess, ess_results$ess_total)) * 0.8,
               # 修改标签，ESS现在直接表示借用的样本量
               label = paste0("At Tipping Point (α = ", 
                             scales::percent(tipping_point, accuracy = 0.1), "):",
                             "\nDrug Borrowed: ", round(tp_drug_ess, 1),
                             "\nPlacebo Borrowed: ", round(tp_placebo_ess, 1),
                             "\nTotal Borrowed: ", round(tp_total_ess, 1)),
               color = "black", hjust = 0, size = 3)
  }
  
  return(p)
}

plot_rjags_group_variance_ratio <- function(ess_results, tipping_point = NA) {
  alpha_min <- min(ess_results$alpha)
  alpha_max <- max(ess_results$alpha)
  
  p <- ggplot(ess_results, aes(x = alpha)) +
    geom_line(aes(y = drug_variance_ratio, color = "Drug Group"), size = 1) +
    geom_line(aes(y = placebo_variance_ratio, color = "Placebo Group"), size = 1) +
    geom_line(aes(y = variance_ratio, color = "Total"), size = 1, linetype = "dashed") +
    
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray50") +
    
    labs(title = "RJAGS Group-Specific Variance Ratio Analysis",
         subtitle = "Ratio of posterior variances without and with borrowing: V1/V2",
         x = "Borrowing Weight (α)",
         y = "Variance Ratio (V1/V2)",
         color = "Group") +
    
    scale_color_manual(values = c("Drug Group" = "blue", 
                                  "Placebo Group" = "red", 
                                  "Total" = "purple")) +
    theme_minimal() +
    scale_x_continuous(labels = scales::percent_format(accuracy = 0.1)) +
    theme(legend.position = "bottom")
  
  if (!is.na(tipping_point)) {
    tp_idx <- which(abs(ess_results$alpha - tipping_point) == min(abs(ess_results$alpha - tipping_point)))
    tp_drug_var_ratio <- ess_results$drug_variance_ratio[tp_idx]
    tp_placebo_var_ratio <- ess_results$placebo_variance_ratio[tp_idx]
    tp_total_var_ratio <- ess_results$variance_ratio[tp_idx]
    
    p <- p + 
      geom_vline(xintercept = tipping_point, linetype = "dotted", color = "black", size = 0.8) +
      annotate("text", x = tipping_point + (alpha_max - alpha_min) * 0.05, 
               y = max(c(ess_results$drug_variance_ratio, ess_results$placebo_variance_ratio, 
                         ess_results$variance_ratio)) * 0.8,
               label = paste0("At Tipping Point (α = ", 
                             scales::percent(tipping_point, accuracy = 0.1), "):",
                             "\nDrug Var Ratio: ", round(tp_drug_var_ratio, 2),
                             "\nPlacebo Var Ratio: ", round(tp_placebo_var_ratio, 2),
                             "\nTotal Var Ratio: ", round(tp_total_var_ratio, 2)),
               color = "black", hjust = 0, size = 3)
  }
  
  return(p)
}
```


### Main Function


```{r}
tipping_point_analysis_rjags <- function(ped_data, adult_data, 
                                       alpha_min = 0.001, alpha_max = 0.5, steps = 50,
                                       n_samples = 10000) {
  # Step 1: Compute the alpha sequence 
  alpha_seq <- seq(alpha_min, alpha_max, length.out = steps)
  
  # Step 2: Run RJAGS analysis
  results <- run_rjags_rr_diff_analyses(ped_data, adult_data, alpha_min, alpha_max, steps)
  
  # Step 3: Find the tipping point
  tipping_point <- find_rjags_rr_diff_tipping_point(results)
  
  # Step 4: Calculate the variance-based ESS
  ess_results <- calculate_ess_from_variance_rjags(ped_data, adult_data, alpha_seq, n_samples)
  
  # Step 5: Create a chart (add a grouped ESS chart)
  p1 <- plot_rjags_rr_diff(results, tipping_point)
  p2 <- plot_rjags_probability(results, tipping_point)
  p3 <- plot_rjags_ess(ess_results, tipping_point, ped_data)
  p4 <- plot_rjags_variance_ratio(ess_results, tipping_point)
  p5 <- plot_rjags_group_ess(ess_results, tipping_point, ped_data)  
  p6 <- plot_rjags_group_variance_ratio(ess_results, tipping_point) 
  

  if (!is.na(tipping_point) && !is.null(ess_results)) {
    tp_idx <- which(abs(ess_results$alpha - tipping_point) == min(abs(ess_results$alpha - tipping_point)))
    
    # 获取临界点处的ESS和方差比（ESS现在直接表示借用的样本量）
    tp_ess <- ess_results$ess_total[tp_idx]
    # 由于ESS现在直接表示借用的样本量，borrowed和ESS相同
    tp_borrowed <- tp_ess
    tp_var_ratio <- ess_results$variance_ratio[tp_idx]
    
    tp_placebo_ess <- ess_results$placebo_ess[tp_idx]
    tp_placebo_borrowed <- tp_placebo_ess
    tp_placebo_var_ratio <- ess_results$placebo_variance_ratio[tp_idx]
    
    tp_drug_ess <- ess_results$drug_ess[tp_idx]
    tp_drug_borrowed <- tp_drug_ess
    tp_drug_var_ratio <- ess_results$drug_variance_ratio[tp_idx]
    
    # 为了兼容性，可以添加总ESS（原始+借用）
    n_placebo <- ped_data$n_placebo
    n_drug <- ped_data$n_drug
    n_total <- n_placebo + n_drug
    
    tp_total_ess <- tp_ess + n_total
    tp_placebo_total_ess <- tp_placebo_ess + n_placebo
    tp_drug_total_ess <- tp_drug_ess + n_drug
    
  } else {
    tp_ess <- NA
    tp_borrowed <- NA
    tp_var_ratio <- NA
    tp_placebo_ess <- NA
    tp_placebo_borrowed <- NA
    tp_placebo_var_ratio <- NA
    tp_drug_ess <- NA
    tp_drug_borrowed <- NA
    tp_drug_var_ratio <- NA
    
    tp_total_ess <- NA
    tp_placebo_total_ess <- NA
    tp_drug_total_ess <- NA
  }
  
  return(list(
    results = results,
    ess_results = ess_results,
    tipping_point = tipping_point,
    
    # 借用的ESS信息（现在直接等于ESS）
    tipping_point_borrowed = tp_ess,
    tipping_point_var_ratio = tp_var_ratio,
    
    # 原始名称保持不变，但值已更改为只表示借用的样本量
    tipping_point_ess = tp_ess,
    tipping_point_placebo_ess = tp_placebo_ess,
    tipping_point_drug_ess = tp_drug_ess,
    
    # 这些值已经变得冗余，但为保持API兼容性而保留
    tipping_point_placebo_borrowed = tp_placebo_borrowed,
    tipping_point_drug_borrowed = tp_drug_borrowed,
    
    # 方差比信息
    tipping_point_placebo_var_ratio = tp_placebo_var_ratio,
    tipping_point_drug_var_ratio = tp_drug_var_ratio,
    
    # 添加总ESS（原始+借用）以便与原始报告进行比较
    tipping_point_total_ess = tp_total_ess,
    tipping_point_placebo_total_ess = tp_placebo_total_ess,
    tipping_point_drug_total_ess = tp_drug_total_ess,
    
    plot_rr_diff = p1,
    plot_prob = p2,
    plot_ess = p3,
    plot_var_ratio = p4,
    plot_group_ess = p5,  
    plot_group_var_ratio = p6  
  ))
}
```


### Run

```{r}
# Run RJAGS Tipping Point analysis
tp_analysis_rjags <- tipping_point_analysis_rjags(pediatric_data, adult_data,
                                      alpha_min = 0.001, 
                                      alpha_max = 0.008, 
                                      steps = 70)
# Display basic charts
tp_analysis_rjags$plot_rr_diff
tp_analysis_rjags$plot_prob
tp_analysis_rjags$plot_ess
tp_analysis_rjags$plot_var_ratio

# Display new group-specific ESS charts
tp_analysis_rjags$plot_group_ess
tp_analysis_rjags$plot_group_var_ratio

# 修改输出文本，明确说明ESS现在表示借用的样本量
cat("RJAGS Tipping Point Alpha:", tp_analysis_rjags$tipping_point, "\n")
cat("Borrowed ESS:", tp_analysis_rjags$tipping_point_ess, "\n")
cat("Total ESS (Original + Borrowed):", tp_analysis_rjags$tipping_point_total_ess, "\n")
cat("Variance Ratio:", tp_analysis_rjags$tipping_point_var_ratio, "\n")

# 组别特定信息
cat("\nPlacebo Group Borrowed ESS:", tp_analysis_rjags$tipping_point_placebo_ess, "\n")
cat("Placebo Group Total ESS:", tp_analysis_rjags$tipping_point_placebo_total_ess, "\n")
cat("Placebo Group Variance Ratio:", tp_analysis_rjags$tipping_point_placebo_var_ratio, "\n")

cat("\nDrug Group Borrowed ESS:", tp_analysis_rjags$tipping_point_drug_ess, "\n")
cat("Drug Group Total ESS:", tp_analysis_rjags$tipping_point_drug_total_ess, "\n")
cat("Drug Group Variance Ratio:", tp_analysis_rjags$tipping_point_drug_var_ratio, "\n")
```