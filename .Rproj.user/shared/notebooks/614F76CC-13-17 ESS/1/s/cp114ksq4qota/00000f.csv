"0","library(ggplot2)"
"0","library(plotly)"
"0","library(dplyr)"
"0",""
"0","run_mixture_plot <- function(data_child, data_adult, weight_grid = seq(0, 1, by = 0.025), nsim = 1e5) {"
"0",""
"0","  res_df <- data.frame("
"0","    weight = weight_grid,"
"0","    median_rr = NA, lower_95_rr = NA, upper_95_rr = NA,"
"0","    ess_total_rr = NA, ess_treat_rr = NA, ess_control_rr = NA"
"0","  )"
"0",""
"0","  prior_flat <- list(a = 1, b = 1)"
"0",""
"0","  # No-borrowing posteriors"
"0","  p1_noborrow <- rbeta(nsim, prior_flat$a + data_child$treat$y,"
"0","                       prior_flat$b + data_child$treat$n - data_child$treat$y)"
"0","  p2_noborrow <- rbeta(nsim, prior_flat$a + data_child$control$y,"
"0","                       prior_flat$b + data_child$control$n - data_child$control$y)"
"0","  var_p1_nob <- var(p1_noborrow)"
"0","  var_p2_nob <- var(p2_noborrow)"
"0",""
"0","  prior_params <- list("
"0","    treat = if (data_adult$treat$n > 0) {"
"0","      list(a = data_adult$treat$y + 1, b = data_adult$treat$n - data_adult$treat$y + 1)"
"0","    } else NULL,"
"0","    control = if (data_adult$control$n > 0) {"
"0","      list(a = data_adult$control$y + 1, b = data_adult$control$n - data_adult$control$y + 1)"
"0","    } else NULL"
"0","  )"
"0",""
"0","  for (i in seq_along(weight_grid)) {"
"0","    w <- weight_grid[i]"
"0",""
"0","    k_treat <- if (!is.null(prior_params$treat)) {"
"0","      C_info <- compute_C(prior_params$treat$a, prior_params$treat$b,"
"0","                          data_child$treat$y, data_child$treat$n)"
"0","      C_flat <- compute_C(prior_flat$a, prior_flat$b,"
"0","                          data_child$treat$y, data_child$treat$n)"
"0","      (w * C_info) / (w * C_info + (1 - w) * C_flat)"
"0","    } else 0"
"0",""
"0","    k_control <- if (!is.null(prior_params$control)) {"
"0","      C_info <- compute_C(prior_params$control$a, prior_params$control$b,"
"0","                          data_child$control$y, data_child$control$n)"
"0","      C_flat <- compute_C(prior_flat$a, prior_flat$b,"
"0","                          data_child$control$y, data_child$control$n)"
"0","      (w * C_info) / (w * C_info + (1 - w) * C_flat)"
"0","    } else 0"
"0",""
"0","    post_p1 <- ifelse("
"0","      runif(nsim) < k_treat,"
"0","      rbeta(nsim, prior_params$treat$a + data_child$treat$y,"
"0","             prior_params$treat$b + data_child$treat$n - data_child$treat$y),"
"0","      rbeta(nsim, prior_flat$a + data_child$treat$y,"
"0","             prior_flat$b + data_child$treat$n - data_child$treat$y)"
"0","    )"
"0",""
"0","    post_p2 <- ifelse("
"0","      runif(nsim) < k_control,"
"0","      rbeta(nsim, prior_params$control$a + data_child$control$y,"
"0","             prior_params$control$b + data_child$control$n - data_child$control$y),"
"0","      rbeta(nsim, prior_flat$a + data_child$control$y,"
"0","             prior_flat$b + data_child$control$n - data_child$control$y)"
"0","    )"
"0",""
"0","    rr_post <- post_p1 - post_p2"
"0",""
"0","    ess_treat <- if (!is.null(prior_params$treat)) (var_p1_nob / var(post_p1) - 1) * data_child$treat$n else 0"
"0","    ess_control <- if (!is.null(prior_params$control)) (var_p2_nob / var(post_p2) - 1) * data_child$control$n else 0"
"0",""
"0","    res_df[i, ] <- c(w, median(rr_post), quantile(rr_post, c(0.025, 0.975)), ess_treat + ess_control, ess_treat, ess_control)"
"0","  }"
"0",""
"0","  # 找 tipping point"
"0","  tipping_idx <- which(res_df$lower_95_rr > 0)[1]"
"0","  k_tp <- if (!is.na(tipping_idx)) res_df$weight[tipping_idx] else NA"
"0",""
"0","  # Plot"
"0","  p <- ggplot(res_df, aes(x = weight, y = median_rr,"
"0","                          text = paste0(""k="", round(weight, 2),"
"0","                                        ""<br>ESS Trt: "", round(ess_treat_rr, 1),"
"0","                                        ""<br>ESS Ctl: "", round(ess_control_rr, 1),"
"0","                                        ""<br>95% CI: ["", round(lower_95_rr, 3), "", "", round(upper_95_rr, 3), ""]""))) +"
"0","    geom_point() +"
"0","    geom_errorbar(aes(ymin = lower_95_rr, ymax = upper_95_rr), width = 0.01) +"
"0","    geom_hline(yintercept = 0, linetype = ""dashed"", color = ""red"") +"
"0","    geom_vline(xintercept = k_tp, linetype = ""dashed"", color = ""blue"") +"
"0","    labs(title = ""Tipping Point with Mixture Prior"","
"0","         x = ""Weight (k)"","
"0","         y = ""Treatment Effect (Difference in Response Rate)"") +"
"0","    theme_minimal()"
"0",""
"0","  # 转换为 plotly 增强交互"
"0","  ggplotly(p, tooltip = ""text"")"
"0","}"
"0",""
"0",""
"0",""
