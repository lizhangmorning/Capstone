---
title: "Untitled"
output: html_document
date: "2025-05-03"
---

```{r}
# ======================
# 1. 数据定义（治疗组 + 对照组同步借用）
# ======================

# 儿童数据
child_data <- list(
  treat = list(y = 15, n = 30),  # 治疗组：15/30
  control = list(y = 1, n = 6)    # 对照组：1/6
)

# 成人数据（用于构建信息先验）
adult_data <- list(
  treat = list(y = 375, n = 509),  # Beta(376, 135)
  control = list(y = 45, n = 494)  # Beta(46, 450)
)

# 平坦先验参数
flat_prior <- list(a = 1, b = 1)  # Beta(1,1)

# ======================
# 2. 计算C_j的核心函数
# ======================

compute_C <- function(a_prior, b_prior, y_data, n_data) {
  # Beta-Binomial边际似然的解析解
  choose(n_data, y_data) * beta(a_prior + y_data, b_prior + n_data - y_data) / beta(a_prior, b_prior)
}

# ======================
# 3. 敏感性分析主函数（同步处理治疗组和对照组）
# ======================

run_sensitivity_analysis <- function(weights = seq(0, 1, 0.05)) {
  # 预分配结果存储
  results <- data.frame(
    weight = weights,
    median_or = NA,
    lower_95 = NA,
    upper_95 = NA,
    post_var = NA,
    ess = NA,
    k_treat = NA,    # 治疗组后验权重
    k_control = NA    # 对照组后验权重
  )
  
  # 无借用时的基准方差计算（两组均用平坦先验）
  set.seed(123)
  p1_no_borrow <- rbeta(1e5, flat_prior$a + child_data$treat$y, 
                        flat_prior$b + child_data$treat$n - child_data$treat$y)
  p2_no_borrow <- rbeta(1e5, flat_prior$a + child_data$control$y, 
                        flat_prior$b + child_data$control$n - child_data$control$y)
  or_no_borrow <- (p1_no_borrow / (1 - p1_no_borrow)) / (p2_no_borrow / (1 - p2_no_borrow))
  var_no_borrow <- var(log(or_no_borrow))
  n_children <- child_data$treat$n + child_data$control$n
  
  # 成人先验参数（治疗组和对照组）
  prior_params <- list(
    treat = list(
      a = adult_data$treat$y + 1,
      b = (adult_data$treat$n - adult_data$treat$y) + 1
    ),
    control = list(
      a = adult_data$control$y + 1,
      b = (adult_data$control$n - adult_data$control$y) + 1
    )
  )
  
  # 循环不同权重
  for (i in seq_along(weights)) {
    w <- weights[i]
    
    # ========== 治疗组后验 ==========
    C_treat <- list(
      info = compute_C(prior_params$treat$a, prior_params$treat$b, 
                       child_data$treat$y, child_data$treat$n),
      flat = compute_C(flat_prior$a, flat_prior$b, 
                       child_data$treat$y, child_data$treat$n)
    )
    k_treat <- (w * C_treat$info) / (w * C_treat$info + (1 - w) * C_treat$flat)
    
    # 生成治疗组后验样本
    post_p1 <- ifelse(
      runif(1e5) < k_treat,
      rbeta(1e5, prior_params$treat$a + child_data$treat$y, 
            prior_params$treat$b + child_data$treat$n - child_data$treat$y),
      rbeta(1e5, flat_prior$a + child_data$treat$y, 
            flat_prior$b + child_data$treat$n - child_data$treat$y)
    )
    
    # ========== 对照组后验 ==========
    C_control <- list(
      info = compute_C(prior_params$control$a, prior_params$control$b, 
                       child_data$control$y, child_data$control$n),
      flat = compute_C(flat_prior$a, flat_prior$b, 
                       child_data$control$y, child_data$control$n)
    )
    k_control <- (w * C_control$info) / (w * C_control$info + (1 - w) * C_control$flat)
    
    # 生成对照组后验样本
    post_p2 <- ifelse(
      runif(1e5) < k_control,
      rbeta(1e5, prior_params$control$a + child_data$control$y, 
            prior_params$control$b + child_data$control$n - child_data$control$y),
      rbeta(1e5, flat_prior$a + child_data$control$y, 
            flat_prior$b + child_data$control$n - child_data$control$y)
    )
    
    # ========== 计算OR ==========
    or_post <- (post_p1 / (1 - post_p1)) / (post_p2 / (1 - post_p2))
    log_or_var <- var(log(or_post))
    
    # 保存结果
    results$median_or[i] <- median(or_post)
    results$lower_95[i] <- quantile(or_post, 0.025)
    results$upper_95[i] <- quantile(or_post, 0.975)
    results$post_var[i] <- log_or_var
    results$ess[i] <- (var_no_borrow / log_or_var - 1) * n_children
    results$k_treat[i] <- k_treat
    results$k_control[i] <- k_control
  }
  
  return(results)
}

# ======================
# 4. 执行分析并可视化
# ======================

# 运行敏感性分析
results <- run_sensitivity_analysis(weights = seq(0, 1, 0.01))

# 查看完整结果
print(results)

# 关键可视化
library(ggplot2)
library(patchwork)  # 用于拼图

# OR的可信区间
p1 <- ggplot(results, aes(x = weight)) +
  geom_line(aes(y = median_or), color = "blue") +
  geom_ribbon(aes(ymin = lower_95, ymax = upper_95), alpha = 0.2, fill = "blue") +
  labs(x = "Weight (w)", y = "Odds Ratio", title = "Posterior OR with Borrowing")

# ESS变化
p2 <- ggplot(results, aes(x = weight, y = ess)) +
  geom_line(color = "red") +
  labs(x = "Weight (w)", y = "ESS", title = "Effective Sample Size")

# 后验权重变化
p3 <- ggplot(results, aes(x = weight)) +
  geom_line(aes(y = k_treat, color = "Treatment")) +
  geom_line(aes(y = k_control, color = "Control")) +
  scale_color_manual(values = c("Treatment" = "darkgreen", "Control" = "purple")) +
  labs(x = "Weight (w)", y = "Posterior Weight", title = "Component Weights") +
  theme(legend.position = "top")

# 拼图显示
(p1 + p2) / p3
```

```{r}
# ======================
# 1. 数据定义
# ======================

# 儿童数据
child_data <- list(
  treat = list(y = 15, n = 30),
  control = list(y = 1, n = 6)
)

# 成人数据
adult_data <- list(
  treat = list(y = 375, n = 509),
  control = list(y = 45, n = 494)
)

# 平坦先验参数
flat_prior <- list(a = 1, b = 1)

# ======================
# 2. 边际似然函数
# ======================

compute_C <- function(a_prior, b_prior, y_data, n_data) {
  choose(n_data, y_data) * beta(a_prior + y_data, b_prior + n_data - y_data) / beta(a_prior, b_prior)
}

# ======================
# 3. 主函数
# ======================

run_sensitivity_analysis <- function(weights = seq(0, 1, 0.01)) {
  results <- data.frame(
    weight = weights,
    median_or = NA,
    lower_95 = NA,
    upper_95 = NA,
    post_var = NA,
    ess_total = NA,
    ess_treat = NA,
    ess_control = NA,
    k_treat = NA,
    k_control = NA
  )
  
  set.seed(123)
  # 无借用（平坦先验）计算基准方差 & 各arm方差
  p1_noborrow <- rbeta(1e5, flat_prior$a + child_data$treat$y,
                       flat_prior$b + child_data$treat$n - child_data$treat$y)
  p2_noborrow <- rbeta(1e5, flat_prior$a + child_data$control$y,
                       flat_prior$b + child_data$control$n - child_data$control$y)
  or_noborrow <- (p1_noborrow / (1 - p1_noborrow)) / (p2_noborrow / (1 - p2_noborrow))
  log_or_var_noborrow <- var(log(or_noborrow))

  # 各arm无借用下的方差
  var_p1_noborrow <- var(log(p1_noborrow / (1 - p1_noborrow)))
  var_p2_noborrow <- var(log(p2_noborrow / (1 - p2_noborrow)))
  
  # 成人先验参数
  prior_params <- list(
    treat = list(
      a = adult_data$treat$y + 1,
      b = adult_data$treat$n - adult_data$treat$y + 1
    ),
    control = list(
      a = adult_data$control$y + 1,
      b = adult_data$control$n - adult_data$control$y + 1
    )
  )
  
  for (i in seq_along(weights)) {
    w <- weights[i]
    
    # 治疗组
    C_treat <- list(
      info = compute_C(prior_params$treat$a, prior_params$treat$b,
                       child_data$treat$y, child_data$treat$n),
      flat = compute_C(flat_prior$a, flat_prior$b,
                       child_data$treat$y, child_data$treat$n)
    )
    k_treat <- (w * C_treat$info) / (w * C_treat$info + (1 - w) * C_treat$flat)
    
    post_p1 <- ifelse(
      runif(1e5) < k_treat,
      rbeta(1e5, prior_params$treat$a + child_data$treat$y,
            prior_params$treat$b + child_data$treat$n - child_data$treat$y),
      rbeta(1e5, flat_prior$a + child_data$treat$y,
            flat_prior$b + child_data$treat$n - child_data$treat$y)
    )
    
    # 对照组
    C_control <- list(
      info = compute_C(prior_params$control$a, prior_params$control$b,
                       child_data$control$y, child_data$control$n),
      flat = compute_C(flat_prior$a, flat_prior$b,
                       child_data$control$y, child_data$control$n)
    )
    k_control <- (w * C_control$info) / (w * C_control$info + (1 - w) * C_control$flat)
    
    post_p2 <- ifelse(
      runif(1e5) < k_control,
      rbeta(1e5, prior_params$control$a + child_data$control$y,
            prior_params$control$b + child_data$control$n - child_data$control$y),
      rbeta(1e5, flat_prior$a + child_data$control$y,
            flat_prior$b + child_data$control$n - child_data$control$y)
    )
    
    # OR计算
    or_post <- (post_p1 / (1 - post_p1)) / (post_p2 / (1 - post_p2))
    log_or_var <- var(log(or_post))
    
    # ESS估计
    ess_total <- (log_or_var_noborrow / log_or_var - 1) * (child_data$treat$n + child_data$control$n)
    ess_treat <- (var_p1_noborrow / var(log(post_p1 / (1 - post_p1))) - 1) * child_data$treat$n
    ess_control <- (var_p2_noborrow / var(log(post_p2 / (1 - post_p2))) - 1) * child_data$control$n
    
    # 存储结果
    results[i, ] <- c(
      w,
      median(or_post),
      quantile(or_post, 0.025),
      quantile(or_post, 0.975),
      log_or_var,
      ess_total,
      ess_treat,
      ess_control,
      k_treat,
      k_control
    )
  }
  
  # 识别 tipping point
  tipping_idx <- which(results$lower_95 > 1)[1]
  if (!is.na(tipping_idx)) {
    tipping_point <- results[tipping_idx, ]
    cat("✅ Tipping Point Found (first lower_95 > 1):\n")
    cat("  ➤ Weight (w*):", tipping_point$weight, "\n")
    cat("  ➤ k_treat =", round(tipping_point$k_treat, 3),
        "| k_control =", round(tipping_point$k_control, 3), "\n")
    cat("  ➤ ESS_treat =", round(tipping_point$ess_treat, 2),
        "| ESS_control =", round(tipping_point$ess_control, 2),
        "| ESS_total =", round(tipping_point$ess_total, 2), "\n")
  } else {
    cat("⚠️ No tipping point found where lower_95 > 1.\n")
  }
  
  return(results)
}

# ======================
# 4. 运行分析 + 可视化
# ======================

results <- run_sensitivity_analysis(seq(0, 1, 0.01))

# 可选：作图
library(ggplot2)
library(patchwork)

p1 <- ggplot(results, aes(x = weight)) +
  geom_line(aes(y = median_or), color = "blue") +
  geom_ribbon(aes(ymin = lower_95, ymax = upper_95), alpha = 0.2, fill = "blue") +
  labs(x = "Weight (w)", y = "Odds Ratio", title = "Posterior OR with Borrowing")

p2 <- ggplot(results, aes(x = weight, y = ess_total)) +
  geom_line(color = "red") +
  labs(x = "Weight (w)", y = "ESS", title = "Total Effective Sample Size")

p3 <- ggplot(results, aes(x = weight)) +
  geom_line(aes(y = k_treat, color = "Treatment")) +
  geom_line(aes(y = k_control, color = "Control")) +
  scale_color_manual(values = c("Treatment" = "darkgreen", "Control" = "purple")) +
  labs(x = "Weight (w)", y = "Posterior Weight", title = "Component Weights") +
  theme(legend.position = "top")

(p1 + p2) / p3

```


